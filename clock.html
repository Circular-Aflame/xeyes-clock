<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>SVG时钟</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <!-- 时钟面 -->
    <div id="face">
        <svg id="canvas">
            <!-- svg写在这一部分 -->
            <circle id="outline" cx=540px cy=360px r=345px stroke="black" stroke-width="3px" fill="transparent">
            </circle>
            <circle id="inline" cx=540px cy=360px r=320px stroke="black" stroke-width="2px" fill="transparent"></circle>
            <polygon id="minPointer" points="538,80 542,80 546,360 534,360" fill=black></polygon>
            <polygon id="houPointer" points="536,150 544,150 548,360 532,360" fill=green></polygon>
            <circle id="secCenter" cx=540 cy=360 r=12 style="fill:red"></circle>
            <polygon id="secPointer" points="538,70 542,70 544,360 536,360" fill=red></polygon>
        </svg>
        <!-- 以下部分需要css样式 -->
        <!-- 数字时钟 -->
        <div id="digital">00:00:00</div>
        <!-- 闹钟 -->
        <div id="alarm">
            <form id="alarmForm">
                闹钟时间: <input type="time" id="alarmTime" value="12:12"><br>
                <input type="radio" name="alarm" value="on" onchange="alarmon()">On<br>
                <input type="radio" name="alarm" value="off" onchange="alarmoff()" checked="true">Off
            </form>
        </div>
        <!-- 秒表 -->
        <!-- 计时器 -->

        <!-- debug用 -->
        <div class="degree" id="degree">0</div>
    </div>
    <script>
        // 中心点位置
        var centerX = 540;
        var centerY = 360;
        // 标准时间调用
        var date = new Date();
        // h,m,s对应小时、分钟、秒钟,t表示秒单位累积时间
        var h, m, s, t;
        // 记录计时函数的id
        var timeid;
        // 记录闹钟是否打开
        var ifalarm = 0;

        // hp,mp,sp分别对应时针、分针、秒针
        var hp = document.getElementById("houPointer");
        addHouRot(hp);

        var mp = document.getElementById("minPointer");
        addMinRot(mp);

        var sp = document.getElementById("secPointer");
        addSecRot(sp);

        // 准备就绪，时间恢复
        resetTime();
        addTime();

        // 重置时间功能
        function resetTime() {
            h = date.getHours();// >= 12 ? (date.getHours() - 12) : date.getHours();
            m = date.getMinutes();
            s = date.getSeconds();
            t = h * 3600 + m * 60 + s;
        }
        // 时间按格式输出
        function formatTime() {
            var hour = h, min = m, sec = s;
            if (h < 10) {
                hour = "0" + h;
            }
            if (m < 10) {
                min = "0" + m;
            }
            if (s < 10) {
                sec = "0" + s;
            }
            return hour + ":" + min + ":" + sec;
        }
        // 无秒
        function formatHM() {
            var hour = h, min = m;
            if (h < 10) {
                hour = "0" + h;
            }
            if (m < 10) {
                min = "0" + m;
            }
            return hour + ":" + min;
        }
        // 时间增加功能
        function addTime() {
            // 有延迟所以设置为900ms
            timeid = setTimeout(addTime, 900);
            t++;
            h = Math.floor(t / 3600);
            m = Math.floor((t % 3600) / 60);
            s = t % 60;
            document.getElementById("digital").innerText = formatTime();
            setPointers();
            if (ifalarm == 1) {
                var al = document.getElementById("alarmTime").value;
                if (al == formatHM()) {
                    confirm("Time's up!!!");
                    ifalarm = 0;
                    document.getElementsByName("alarm")[1].checked = true;
                }
            }
        }
        // 时间刷新
        function setTime() {
            // 保持24小时
            if (t > 86400) {
                t =t% 86400;
            }
            h = Math.floor(t / 3600);
            m = Math.floor((t % 3600) / 60);
            s = t % 60;
            document.getElementById("digital").innerText = formatTime();
        }
        // 刷新指针
        function setPointers() {
            // 秒针部件
            var secR = Math.floor(s * 6);
            sp.setAttribute("transform", "rotate(" + secR + " " + centerX + " " + centerY + ")");
            // 分针部件
            var minR = Math.floor(m * 6 + s / 10);
            mp.setAttribute("transform", "rotate(" + minR + " " + centerX + " " + centerY + ")");
            // 时针部件
            var houR = Math.floor(h * 30 + m / 2);
            hp.setAttribute("transform", "rotate(" + houR + " " + centerX + " " + centerY + ")");
        }
        // 添加鼠标拨动功能
        function addSecRot(p) {
            // 鼠标按下开始
            p.addEventListener("mouseup", addTime);
            p.addEventListener("mousedown", function (event) {
                var lastAngle = Math.atan2(event.clientY - centerY, event.clientX - centerX) * 180 / Math.PI;
                clearTimeout(timeid);
                var accu = 0;
                var ot = t;

                // 移动时调用函数
                document.addEventListener("mousemove", rotatePointer);

                // 抬起时删除移动函数
                document.addEventListener("mouseup", function () {
                    document.removeEventListener("mousemove", rotatePointer);
                });

                function rotatePointer(event) {
                    var currentAngle = Math.atan2(event.clientY - centerY, event.clientX - centerX) * 180 / Math.PI;
                    var added = currentAngle - lastAngle;
                    if (currentAngle > 90 && lastAngle < -90) {
                        added -= 360;
                    }
                    if (currentAngle < -90 && lastAngle > 90) {
                        added += 360;
                    }
                    accu += added;
                    t = ot + Math.floor(accu / 6);
                    setTime();
                    lastAngle = currentAngle;
                    var rotation = currentAngle + 90;
                    p.setAttribute("transform", "rotate(" + rotation + " " + centerX + " " + centerY + ")");
                }
            });
        }
        function addMinRot(p) {
            // 鼠标按下开始
            p.addEventListener("mouseup", addTime);
            p.addEventListener("mousedown", function (event) {
                var lastAngle = Math.atan2(event.clientY - centerY, event.clientX - centerX) * 180 / Math.PI;
                clearTimeout(timeid);
                var accu = 0;
                var ot = t;

                // 移动时调用函数
                document.addEventListener("mousemove", rotatePointer);

                // 抬起时删除移动函数
                document.addEventListener("mouseup", function () {
                    document.removeEventListener("mousemove", rotatePointer);
                });

                function rotatePointer(event) {
                    var currentAngle = Math.atan2(event.clientY - centerY, event.clientX - centerX) * 180 / Math.PI;
                    var added = currentAngle - lastAngle;
                    if (currentAngle > 90 && lastAngle < -90) {
                        added -= 360;
                    }
                    if (currentAngle < -90 && lastAngle > 90) {
                        added += 360;
                    }
                    accu += added;
                    t = ot + Math.floor(accu * 10);
                    setTime();
                    lastAngle = currentAngle;
                    var rotation = currentAngle + 90;
                    p.setAttribute("transform", "rotate(" + rotation + " " + centerX + " " + centerY + ")");
                }
            });
        }
        function addHouRot(p) {
            // 鼠标按下开始
            p.addEventListener("mouseup", addTime);
            p.addEventListener("mousedown", function (event) {
                var lastAngle = Math.atan2(event.clientY - centerY, event.clientX - centerX) * 180 / Math.PI;
                clearTimeout(timeid);
                var accu = 0;
                var ot = t;

                // 移动时调用函数
                document.addEventListener("mousemove", rotatePointer);

                // 抬起时删除移动函数
                document.addEventListener("mouseup", function () {
                    document.removeEventListener("mousemove", rotatePointer);
                });

                function rotatePointer(event) {
                    var currentAngle = Math.atan2(event.clientY - centerY, event.clientX - centerX) * 180 / Math.PI;
                    var added = currentAngle - lastAngle;
                    if (currentAngle > 90 && lastAngle < -90) {
                        added -= 360;
                    }
                    if (currentAngle < -90 && lastAngle > 90) {
                        added += 360;
                    }
                    accu += added;
                    t = ot + Math.floor(accu * 120);
                    setTime();
                    lastAngle = currentAngle;
                    var rotation = currentAngle + 90;
                    p.setAttribute("transform", "rotate(" + rotation + " " + centerX + " " + centerY + ")");
                }
            });
        }
        // 闹钟函数
        function alarmon() {
            ifalarm = 1;
        }
        function alarmoff() {
            ifalarm = 0;
        }
    </script>
</body>

</html>